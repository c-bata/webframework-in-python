
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>レスポンスオブジェクト &#8212; Webアプリケーションフレームワークの作り方 in Python</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="JSONやHTMLを返す" href="template.html" />
    <link rel="prev" title="リクエストオブジェクト" href="request.html" /><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'>
  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
        <div class="container" >
            <a href="index.html" class="nav-title">Webアプリケーションフレームワークの作り方 in Python</a>
            <ul class="nav">
                <li><a href="genindex.html" title="総合索引" accesskey="I">索引</a></li>
                <li><a href="template.html" title="JSONやHTMLを返す" accesskey="N">次へ</a></li>
                <li><a href="request.html" title="リクエストオブジェクト" accesskey="P">前へ</a></li>
            </ul>
        </div>
    </div>

    <div class="document">
        <div class="container">
            <div class="contents" role="main">
                
  <div class="section" id="id1">
<h1>レスポンスオブジェクト<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id2">
<h2>レスポンス情報の扱いについて<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>リクエスト情報が簡単に取り扱えるようになったので、次はレスポンス情報の扱い方を見直します。
各エンドポイントの処理は次のように定義していました。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain; charset=utf-8&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;Hello World&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>ここで気になるのは、レスポンス情報の返し方です。
WSGIのインターフェイスでは、レスポンスステータスとレスポンスヘッダーを第2引数で受け取る <code class="docutils literal notranslate"><span class="pre">start_response</span></code> 関数により指定します。
これはFlaskやBottleのサンプルコードに比べると、少々面倒に感じます。
もう少し簡単に管理できるように、Response情報をラップするクラスがあると便利かもしれません。
具体的には次のように各エンドポイントの処理を記述できるようにしてみます。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;^/user/$&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;User is created&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Response</span></code> クラスというのを追加して、レスポンスボディやヘッダー情報、ステータスコードの番号をそこに指定できるようにしました。
クラスでラップしているので、デフォルトのヘッダー情報も継承を使って自由に変更することもできます。</p>
</div>
<div class="section" id="id3">
<h2>ヘッダー情報とステータス情報を簡単に扱う方法<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Responseクラスを実装していく前に、ヘッダー情報とステータス情報を簡単に扱う方法を詳解します。
まずはステータス情報の扱いです。 <code class="docutils literal notranslate"><span class="pre">start_response</span></code> の第一引数にはステータスコードを <code class="docutils literal notranslate"><span class="pre">200</span> <span class="pre">OK</span></code> や <code class="docutils literal notranslate"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></code> のように指定しますが、
番号に対応する文字列は決まっているので、番号の指定だけで済むほうが楽なものです。
<code class="docutils literal notranslate"><span class="pre">http.client</span></code> モジュールの <code class="docutils literal notranslate"><span class="pre">responses</span></code> オブジェクトには、ステータスコードの番号に対するメッセージが格納されています。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">responses</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">responses</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span>
<span class="go">&#39;OK&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">responses</span><span class="p">[</span><span class="mi">404</span><span class="p">]</span>
<span class="go">&#39;Not Found&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">responses</span><span class="p">[</span><span class="mi">500</span><span class="p">]</span>
<span class="go">&#39;Internal Server Error&#39;</span>
</pre></div>
</div>
<p>非常に簡単に取り出すことができました。ユーザーは <code class="docutils literal notranslate"><span class="pre">200</span></code> のように番号を指定してあげるだけで、次のようにステータスコードを生成できます。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">responses</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">get_status_code</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{number} {responses[number]}&quot;</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_status_code</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="go">&#39;200 OK&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_status_code</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
<span class="go">&#39;400 Bad Request&#39;</span>
</pre></div>
</div>
<p>ステータス情報の管理には <code class="docutils literal notranslate"><span class="pre">wsgiref.headers</span></code> モジュールの中にある <code class="docutils literal notranslate"><span class="pre">Header</span></code> クラスが便利です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">wsgiref.headers</span> <span class="kn">import</span> <span class="n">Headers</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="go">[(&#39;Content-type&#39;, &#39;text/plain&#39;), (&#39;Foo&#39;, &#39;bar&#39;)]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">add_header(key,</span> <span class="pre">value)</span></code> メソッドをとおして、ヘッダー情報をセットします。
またWSGIの仕様上、ヘッダー情報をキーとバリューのタプルのリストを用意する必要がありますが、
<code class="docutils literal notranslate"><span class="pre">items()</span></code> メソッドはその形式でヘッダー情報を吐き出してくれます。</p>
</div>
<div class="section" id="response">
<h2>Responseクラスを用意して組み込む<a class="headerlink" href="#response" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Response</span></code> クラスは次のようになります。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">http.client</span> <span class="kn">import</span> <span class="n">responses</span> <span class="k">as</span> <span class="n">http_responses</span>
<span class="kn">from</span> <span class="nn">wsgiref.headers</span> <span class="kn">import</span> <span class="n">Headers</span>

<span class="k">class</span> <span class="nc">Response</span><span class="p">:</span>
    <span class="n">default_status</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">default_charset</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>
    <span class="n">default_content_type</span> <span class="o">=</span> <span class="s1">&#39;text/html; charset=UTF-8&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_charset</span>

        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">http_responses</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">header_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;Content-Type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_content_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="p">]</span>
</pre></div>
</div>
<p>デフォルトのステータスコードやコンテントタイプをクラス変数にもたせておくことにしました。
ユーザーはレスポンスボディの内容を文字列で指定していますが、WSGIのインターフェイスではバイト文字列を yield するイテラブルなオブジェクトとして返さなくてはいけません。
<code class="docutils literal notranslate"><span class="pre">body</span></code> プロパティメソッドが適切に文字列をエンコードして返してくれます。</p>
<p>アプリケーションにも組み込んでみましょう。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="n">callback</span><span class="p">,</span> <span class="n">url_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">url_vars</span><span class="p">)</span>
        <span class="n">start_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">header_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
</pre></div>
</div>
<p>組み込みはこのように非常に簡単です。これまでとは違い <code class="docutils literal notranslate"><span class="pre">start_response</span></code> を各関数に渡す必要はありません。
そのかわり返ってきたレスポンスオブジェクトから、ステータス情報とヘッダー情報を取り出して呼び出して上げる必要があります。</p>
<p>こうするとユーザーの定義する関数は驚くほどシンプルになります。
具体的には、次のようになりました。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.app</span> <span class="k">import</span> <span class="n">App</span><span class="p">,</span> <span class="n">Response</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;^/user/$&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;User Created&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;^/user/(?P&lt;name&gt;\w+)$&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Hello </span><span class="si">{name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</div>
<p>いかがでしょう、FlaskやBottleを使ったことのある方には随分と見慣れた形になってきたのではないでしょうか。</p>
</div>
<div class="section" id="id4">
<h2>まとめ<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ここではレスポンス情報の扱いを見直しました。
Responseクラスを追加することで随分ユーザーにとって使いやすいAPIに変えることができました。
実際にアプリケーションを作っていくにはまだまだ欲しい機能がありますが、ここまでくればまさにWebフレームワークと言えるものになってきたのではないでしょうか。</p>
<p>ここでは全部文字列をただ返していましたが、実際のユースケースではHTMLやJSONを返すことが多いでしょう。
その内容は次の節で扱っていきます。</p>
</div>
</div>


            </div>
<div class="customsidebar" role="navigation" aria-label="main navigation">
    <p class="logo"><a href="index.html">
        <img class="logo" src="_static/kobin.png" alt="Logo"/>
    </a></p>
  <h3><a href="index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">レスポンスオブジェクト</a><ul>
<li><a class="reference internal" href="#id2">レスポンス情報の扱いについて</a></li>
<li><a class="reference internal" href="#id3">ヘッダー情報とステータス情報を簡単に扱う方法</a></li>
<li><a class="reference internal" href="#response">Responseクラスを用意して組み込む</a></li>
<li><a class="reference internal" href="#id4">まとめ</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="request.html"
                        title="前の章へ">リクエストオブジェクト</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="template.html"
                        title="次の章へ">JSONやHTMLを返す</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/response.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
</div>
        </div>
    </div>
    <div class="footer">
        <div class="container">
            &copy; Copyright 2016, Masashi Shibata.
            Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.4.1.
        </div>
    </div>
  </body>
</html>